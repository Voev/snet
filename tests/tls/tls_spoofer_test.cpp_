#include <gtest/gtest.h>
#include <snet/tls.hpp>

#include <snet/crypto/asymm_keygen.hpp>
#include <snet/crypto/cert_authority.hpp>

using namespace snet::crypto;
using namespace snet::tls;
using namespace testing;

static constexpr std::size_t kDefaultBufferSize{4096};


struct TlsSpooferTestParam
{
    ProtocolVersion version;
};

class TlsSpooferTest : public TestWithParam<TlsSpooferTestParam>
{
public:
    TlsSpooferTest()
        : ca_("CN=Test Root CA")
        , recordPool_(64)
    {
    }

    ~TlsSpooferTest() = default;

    void SetUp() override
    {
        clientSettings_.setSecurityLevel(SecurityLevel::Level0);

        auto serverKey = akey::rsa::generate(2048);
        auto serverCert = ca_.sign("CN=Test Server", serverKey.get());

        ASSERT_NO_THROW(serverSettings_.setMaxVersion(ProtocolVersion::TLSv1_2));
        ASSERT_NO_THROW(serverSettings_.useCertificate(serverCert.get()));
        ASSERT_NO_THROW(serverSettings_.usePrivateKey(serverKey.get()));
    }

    void TearDown() override
    {
    }

protected:
    CertAuthority ca_;
    RecordPool recordPool_;
    ClientSettings clientSettings_;
    ServerSettings serverSettings_;
    Session spoofClient_;
    Session spoofServer_;
};

TEST_P(TlsSpooferTest, IterativeHandshake)
{
    std::error_code ec;

    size_t clientBufferSize{::kDefaultBufferSize};
    size_t serverBufferSize{::kDefaultBufferSize};

    std::vector<uint8_t> clientBuffer(clientBufferSize);
    std::vector<uint8_t> serverBuffer(serverBufferSize);

    StateMachine client(clientSettings_);
    StateMachine server(serverSettings_);

    const auto& param = GetParam();
    ASSERT_NO_THROW(client.setVersion(param.version));
    ASSERT_NO_THROW(server.setVersion(param.version));

    serverBufferSize = 0;
    do
    {
        clientBufferSize = clientBuffer.size();
        ASSERT_EQ(Want::Nothing, client.handshake(nullptr, 0,
                                                  clientBuffer.data(), &clientBufferSize, ec));
        ASSERT_FALSE(ec) << ec.message();

        ASSERT_NO_THROW(spoofServer_.processRecords(1, clientBuffer));

        serverBufferSize = serverBuffer.size();
        ASSERT_EQ(Want::Nothing, server.handshake(session->sendingBuffer, session->sendingLength,
                                                  serverBuffer.data(), &serverBufferSize, ec));
        ASSERT_FALSE(ec) << ec.message();

        spoofer_.process(1, session.get(), serverBuffer.data(), serverBufferSize);

    } while (!client.afterHandshake());

    ASSERT_TRUE(server.afterHandshake());
}

INSTANTIATE_TEST_SUITE_P(ParametrizedSpooferTests, TlsSpooferTest,
                         testing::Values(//TlsSpooferTestParam{ProtocolVersion::TLSv1_0},
                                         //TlsSpooferTestParam{ProtocolVersion::TLSv1_1},
                                         //TlsSpooferTestParam{ProtocolVersion::TLSv1_2},
                                         TlsSpooferTestParam{ProtocolVersion::TLSv1_3}));